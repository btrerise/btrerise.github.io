<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleeper Roster Fetcher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen font-[Inter]">

<div id="app" class="w-full max-w-2xl bg-white rounded-xl shadow-2xl p-8 space-y-8 m-4 md:m-8">
    
    <div id="auth-status" class="flex flex-col md:flex-row items-center justify-between space-y-2 md:space-y-0 text-sm md:text-base">
        <div class="flex items-center space-x-2">
            <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
            <span id="user-status-text" class="font-semibold text-gray-700"></span>
        </div>
        <button id="sign-out-button" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-300 shadow-md">Sign Out</button>
    </div>

    <div class="space-y-4">
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">Sleeper Roster Fetcher</h1>
            <p class="mt-2 text-gray-600">Enter your Sleeper user and league IDs to fetch and save your roster.</p>
        </div>

        <form id="fetch-form" class="space-y-4">
            <div>
                <label for="sleeperUserId" class="block text-sm font-medium text-gray-700 mb-1">Sleeper User ID</label>
                <input type="text" id="sleeperUserId" placeholder="Your_Sleeper_Username" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
            </div>
            <div>
                <label for="sleeperLeagueId" class="block text-sm font-medium text-gray-700 mb-1">Sleeper League ID</label>
                <input type="text" id="sleeperLeagueId" placeholder="e.g., 1234567890" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
            </div>
            <button type="submit" id="fetch-button" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg">Fetch Roster</button>
        </form>

        <div id="status-message" class="mt-4 p-4 text-sm font-semibold text-center rounded-lg hidden"></div>
    </div>

    <div id="roster-container" class="space-y-4">
        <h2 class="text-2xl font-bold text-gray-900">Your Rostered Players</h2>
        <div id="roster-list" class="space-y-2">
            <!-- Player cards will be inserted here -->
        </div>
    </div>
    
    <div id="no-roster-message" class="text-center text-gray-500 hidden">
        <p>No roster found. Please fetch your roster using the form above.</p>
    </div>

</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

<script type="module">
    // Core Firebase config and initialization.
    // NOTE: In a real app, these values would come from environment variables.
    // For this demonstration, they are hardcoded.
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

    // Initialize Firebase and Firestore
    let app, auth, db, userId;
    
    // Check for canvas environment variables to initialize Firebase.
    if (Object.keys(firebaseConfig).length > 0) {
        app = firebase.initializeApp(firebaseConfig);
        auth = firebase.getAuth(app);
        db = firebase.getFirestore(app);
    } else {
        console.warn('Firebase config not found. The app will not be able to save data to Firestore. Please run in a Canvas environment.');
    }

    const { signInWithCustomToken, onAuthStateChanged, signInAnonymously } = firebase.auth;
    const { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, deleteDoc } = firebase.firestore;
    
    // UI Elements
    const authStatusEl = document.getElementById('auth-status');
    const userStatusTextEl = document.getElementById('user-status-text');
    const signOutButtonEl = document.getElementById('sign-out-button');
    const fetchForm = document.getElementById('fetch-form');
    const fetchButton = document.getElementById('fetch-button');
    const statusMessageEl = document.getElementById('status-message');
    const rosterListEl = document.getElementById('roster-list');
    const rosterContainer = document.getElementById('roster-container');
    const noRosterMessage = document.getElementById('no-roster-message');

    // Firestore Path Constants
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const getUserDataPath = (uid) => `artifacts/${appId}/users/${uid}`;
    const getRosterCollectionPath = (uid) => `${getUserDataPath(uid)}/rosters`;
    const getRosterDocPath = (uid, leagueId) => `${getRosterCollectionPath(uid)}/${leagueId}`;

    // Helper functions
    const showMessage = (message, type = 'info') => {
        statusMessageEl.textContent = message;
        statusMessageEl.className = `mt-4 p-4 text-sm font-semibold text-center rounded-lg`;
        if (type === 'info') {
            statusMessageEl.classList.add('bg-blue-100', 'text-blue-800');
        } else if (type === 'success') {
            statusMessageEl.classList.add('bg-green-100', 'text-green-800');
        } else if (type === 'error') {
            statusMessageEl.classList.add('bg-red-100', 'text-red-800');
        }
        statusMessageEl.classList.remove('hidden');
    };

    const clearMessage = () => {
        statusMessageEl.classList.add('hidden');
    };

    const toggleLoading = (isLoading) => {
        if (isLoading) {
            fetchButton.textContent = 'Fetching...';
            fetchButton.disabled = true;
            fetchButton.classList.add('bg-blue-400', 'cursor-not-allowed');
            fetchButton.classList.remove('hover:bg-blue-700');
        } else {
            fetchButton.textContent = 'Fetch Roster';
            fetchButton.disabled = false;
            fetchButton.classList.remove('bg-blue-400', 'cursor-not-allowed');
            fetchButton.classList.add('hover:bg-blue-700');
        }
    };

    const renderRoster = (players) => {
        rosterListEl.innerHTML = '';
        if (players.length === 0) {
            rosterContainer.classList.add('hidden');
            noRosterMessage.classList.remove('hidden');
        } else {
            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'bg-gray-50 rounded-lg p-4 shadow-sm flex items-center justify-between';
                playerCard.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold text-lg">${player.name}</span>
                        <span class="text-sm text-gray-500">${player.position}</span>
                    </div>
                `;
                rosterListEl.appendChild(playerCard);
            });
            rosterContainer.classList.remove('hidden');
            noRosterMessage.classList.add('hidden');
        }
    };
    
    // Main logic
    if (app) {
        // Initial authentication
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch((error) => {
                console.error("Error signing in with custom token:", error);
            });
        } else {
            signInAnonymously(auth).catch((error) => {
                console.error("Error signing in anonymously:", error);
            });
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userStatusTextEl.textContent = `Signed in as: ${userId}`;
                signOutButtonEl.classList.remove('hidden');
                // Fetch and display saved roster on load
                await fetchAndDisplaySavedRoster();
            } else {
                userId = null;
                userStatusTextEl.textContent = 'Not signed in.';
                signOutButtonEl.classList.add('hidden');
                rosterContainer.classList.add('hidden');
                noRosterMessage.classList.remove('hidden');
            }
        });

        signOutButtonEl.addEventListener('click', async () => {
            await auth.signOut();
            showMessage('Signed out successfully.', 'info');
        });

        const fetchRoster = async (sleeperUserId, sleeperLeagueId) => {
            const url = `https://api.sleeper.app/v1/league/${sleeperLeagueId}/rosters`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Find the user's roster
                const userRoster = data.find(roster => roster.owner_id === sleeperUserId);
                
                if (!userRoster || !userRoster.players) {
                    throw new Error(`Roster data for user "${sleeperUserId}" could not be found.`);
                }
                
                // Fetch player details
                const playersUrl = 'https://api.sleeper.app/v1/players/nfl';
                const playersResponse = await fetch(playersUrl);
                const allPlayers = await playersResponse.json();

                const rosteredPlayers = userRoster.players.map(playerId => {
                    const playerDetails = allPlayers[playerId];
                    return {
                        name: playerDetails ? playerDetails.full_name : 'Unknown Player',
                        position: playerDetails ? playerDetails.position : 'Unknown',
                    };
                });
                
                return rosteredPlayers;
            } catch (error) {
                console.error("Failed to fetch roster:", error);
                throw new Error(`Failed to fetch roster: ${error.message}`);
            }
        };

        const saveRosterToFirestore = async (leagueId, players) => {
            if (!userId) {
                throw new Error('User not authenticated.');
            }
            try {
                const docRef = doc(db, getRosterDocPath(userId, leagueId));
                await setDoc(docRef, {
                    lastUpdated: new Date(),
                    players: players
                });
                showMessage('Roster saved successfully!', 'success');
            } catch (error) {
                console.error("Error saving roster to Firestore:", error);
                showMessage('Error saving roster to Firestore.', 'error');
            }
        };

        const fetchAndDisplaySavedRoster = async () => {
            if (!userId) return;
            try {
                const q = query(collection(db, getRosterCollectionPath(userId)));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.docs.length > 0) {
                    // Display the most recently updated roster
                    const mostRecentRoster = querySnapshot.docs.reduce((latest, current) => {
                        const latestDate = latest.data().lastUpdated.toDate();
                        const currentDate = current.data().lastUpdated.toDate();
                        return currentDate > latestDate ? current : latest;
                    });
                    
                    const players = mostRecentRoster.data().players;
                    renderRoster(players);
                } else {
                    renderRoster([]);
                }
            } catch (error) {
                console.error("Error fetching saved roster:", error);
                renderRoster([]);
            }
        };

        fetchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearMessage();
            toggleLoading(true);

            const sleeperUserId = document.getElementById('sleeperUserId').value.trim();
            const sleeperLeagueId = document.getElementById('sleeperLeagueId').value.trim();

            if (!sleeperUserId || !sleeperLeagueId) {
                showMessage('Please enter both IDs.', 'error');
                toggleLoading(false);
                return;
            }

            try {
                const roster = await fetchRoster(sleeperUserId, sleeperLeagueId);
                renderRoster(roster);
                await saveRosterToFirestore(sleeperLeagueId, roster);
            } catch (error) {
                console.error(error);
                showMessage(`Error: ${error.message}`, 'error');
                renderRoster([]);
            } finally {
                toggleLoading(false);
            }
        });
    }
</script>
</body>
</html>
